# Standoff2

Одностраничная веб-игра с PWA-функциями и **онлайн-рынком** для торговли предметами.

## Что сделано

- Подготовлен деплой под **Netlify** (`netlify.toml`).
- Добавлены **Netlify Functions** для настоящего онлайн-рынка (`/api/market`).
- Добавлена SQL-схема для **Supabase Postgres** (`db/supabase.sql`) c таблицей лотов и атомарной покупкой.
- Фронтенд рынка переведён на работу через API:
  - получение лотов из БД,
  - выставление предмета на продажу,
  - покупка лота с защитой от двойной покупки,
  - fallback в офлайн-режим, если API недоступен.

## Архитектура рынка

- Клиент: `патчада.html`
- API: `netlify/functions/market.js`
- БД: Supabase Postgres (`market_listings`, функция `purchase_market_listing`)

## Настройка окружения Netlify

В переменные окружения сайта добавьте:

- `SUPABASE_URL` — URL вашего Supabase-проекта.
- `SUPABASE_SERVICE_ROLE_KEY` — service role key (хранить только на сервере/в Netlify).

## Запуск базы

1. Откройте SQL Editor в Supabase.
2. Выполните SQL из файла `db/supabase.sql`.

## Локальная проверка

- Рекомендуется запускать через Netlify CLI, чтобы работали функции (`/.netlify/functions/*`).
- При запуске без функций приложение продолжит работать, но рынок перейдёт в офлайн-режим.
