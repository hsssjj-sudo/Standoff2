# Standoff2

Одностраничная веб-игра с PWA-функциями и **онлайн-рынком** для торговли предметами.

## Что сделано

- Подготовлен деплой под **Netlify** (`netlify.toml`) с проксированием `/api/*` в Netlify Functions.
- Добавлены **Netlify Functions** для настоящего онлайн-рынка (`/api/market`).
- Добавлена SQL-схема для **Supabase Postgres** (`db/supabase.sql`) c таблицей лотов и атомарной покупкой.
- Фронтенд рынка переведён на работу через API:
  - получение лотов из БД,
  - выставление предмета на продажу,
  - покупка лота с защитой от двойной покупки,
  - fallback в офлайн-режим, если API недоступен.

## Архитектура рынка

- Клиент: `патчада.html`
- API: `netlify/functions/market.js`
- БД: Supabase Postgres (`market_listings`, функция `purchase_market_listing`)

## Настройка окружения Netlify

В переменные окружения сайта добавьте:

- `SUPABASE_URL` — URL вашего Supabase-проекта.
- `SUPABASE_SERVICE_ROLE_KEY` — service role key (хранить только на сервере/в Netlify).

## Почему рынок может показываться офлайн

Если сайт запущен не через Netlify, маршрут `/api/market` может отсутствовать и давать 404.
Теперь клиент пробует оба пути API:
- `/api/market` (деплой Netlify с редиректом)
- `/.netlify/functions/market` (локальный `netlify dev`)

Если оба пути недоступны, рынок корректно уходит в офлайн-режим.
Также проверьте, что заданы `SUPABASE_URL` и `SUPABASE_SERVICE_ROLE_KEY`.

## Запуск базы

1. Откройте SQL Editor в Supabase.
2. Выполните SQL из файла `db/supabase.sql`.

## Локальная проверка

- Рекомендуется запускать через Netlify CLI, чтобы работали функции (`/.netlify/functions/*`) и маршрут `/api/*`.
- При запуске без функций приложение продолжит работать, но рынок перейдёт в офлайн-режим.
